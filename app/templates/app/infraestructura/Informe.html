{% extends '../base.html' %}

{% block content %}
<div class="container mt-9 text-white">
    <h2 class="mb-4">Crear Informe</h2>
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        {% csrf_token %}

        <!-- Campo de ubicación con botón añadir -->
        <div class="md-form d-flex align-items-center">
            <div class="flex-grow-1 mr-2">
                {{ form.ubicacion.label_tag }}
                {{ form.ubicacion }}
                <div class="invalid-feedback">
                    {% for error in form.ubicacion.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            </div>
            <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#addLocationModal">
                <i class="fas fa-plus"></i> Añadir
            </button>
        </div>

        <!-- Campo de tipo de informe -->
        <div class="md-form">
            {{ form.categoría.label_tag }}
            {{ form.categoría }}
            <div class="invalid-feedback">
                {% for error in form.categoría.errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        </div>

        <!-- Campo de objetivo -->
        <div class="md-form">
            {{ form.objetivo.label_tag }}
            {{ form.objetivo }}
            <div class="invalid-feedback">
                {% for error in form.objetivo.errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        </div>

        <!-- Campo de mensaje -->
        <div class="md-form">
            {{ form.mensaje.label_tag }}
            {{ form.mensaje }}
            <div class="invalid-feedback">
                {% for error in form.mensaje.errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        </div>

        <!-- Campo de imagen -->
        <div class="md-form">
            {{ form.imagen.label_tag }}
            {{ form.imagen }}
            <div class="invalid-feedback">
                {% for error in form.imagen.errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
            <!-- Vista previa de la imagen -->
            <div>
                <img id="imagen-preview" src="#" alt="Vista previa de la imagen" style="display: none; max-width: 100%; height: auto; margin-top: 10px;">
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Enviar</button>
    </form>
</div>



<!-- Modal para añadir ubicación -->
<div class="modal fade" id="addLocationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Añadir Nueva Ubicación</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addLocationForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="locationName">Nombre de la ubicación</label>
                        <input type="text" class="form-control" id="locationName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="saveLocation">Guardar</button>
            </div>
        </div>
    </div>
</div>


<script>
    const imageInput = document.getElementById('id_imagen');  // Seleccionamos el input de archivo
    const imagePreview = document.getElementById('imagen-preview');  // Vista previa de la imagen

    if (imageInput) {
        imageInput.addEventListener('change', function (event) {
            const file = event.target.files[0];  // Obtenemos el archivo seleccionado
            if (file) {
                const fileType = file.type.split('/')[0];  // Verificamos que sea una imagen
                if (fileType === 'image') {
                    const reader = new FileReader();  // Creamos un nuevo FileReader
                    reader.onload = function (e) {
                        // Cuando el archivo se haya leído, lo asignamos como src del preview
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';  // Mostramos la imagen previa
                    };
                    reader.readAsDataURL(file);  // Leemos el archivo como una URL de datos
                } else {
                    // Si no es una imagen, mostramos un mensaje de error
                    alert('Tipo de archivo no válido. Por favor selecciona una imagen.');
                    imageInput.value = '';  // Limpiamos el campo
                    imagePreview.style.display = 'none';  // Ocultamos la vista previa
                }
            }
        });
    }

    document.getElementById('saveLocation').addEventListener('click', function() {
        const locationName = document.getElementById('locationName').value;
        if (!locationName) {
            alert('Por favor ingrese un nombre para la ubicación');
            return;
        }

        fetch('/agregar-ubicacion/', {  // Necesitarás crear esta URL
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({ nombre: locationName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Agregar nueva opción al select
                const select = document.getElementById('id_ubicacion');
                const option = new Option(locationName, data.id);
                select.add(option);
                select.value = data.id;
                
                // Cerrar modal
                $('#addLocationModal').modal('hide');
                document.getElementById('locationName').value = '';
            } else {
                alert('Error al agregar la ubicación: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
        });
    });
</script>
{% endblock %}